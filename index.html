<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§ÙÙ‡ ØªÛŒØ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Tahoma, Arial, sans-serif;
            background: #f5f5f5;
            direction: rtl;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .editor-panel {
            width: 100%;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #e0e0e0;
        }

        .preview-panel {
            width: 50%;
            background: #f9f9f9;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .editor-panel,
            .preview-panel {
                width: 100%;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: Tahoma, Arial, sans-serif;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .menu-item-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .menu-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-hidden-checkbox {
            display: flex;
            gap: 10px;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-tab.active {
            background: #667eea;
            color: white;
        }

        .preview-frame {
            width: 100%;
            height: calc(100vh - 100px);
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .auth-section {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div id="authSection" class="auth-section" style="display:none;">
        <div class="header">
            <h1>ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</h1>
            <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØªØŒ ØªÙˆÚ©Ù† GitHub Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
        <div class="form-group">
            <label>GitHub Personal Access Token</label>
            <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div class="form-group">
            <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ GitHub / Ù†Ø§Ù… Repository</label>
            <input type="text" id="repoInput" placeholder="username/repository">
        </div>
        <button class="btn btn-success" onclick="authenticate()">ÙˆØ±ÙˆØ¯</button>
    </div>

    <div id="mainContainer" class="container" style="display:none;">
        <div class="editor-panel">
            <div class="header">
                <h1>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§ÙÙ‡ ØªÛŒØ§</h1>
            </div>

            <div id="statusMessage" class="status-message"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>

            <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
            <div class="section">
                <div class="section-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</div>

                <div class="form-group">
                    <p>ØªØµÙˆÛŒØ± Ù‡ÛŒØ±Ùˆ</p>
                    <div class="image-upload" onclick="document.getElementById('mixedInput').click()">
                        <p>ğŸ“ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯
                            <br />
                            (Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û°Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª)
                        </p>
                        <input type="file" id="mixedInput" accept="image/*,video/*" style="display:none;"
                            onchange="handleMediaUpload('hero', this)">
                    </div>
                    <img id="mixedPreview" class="media-preview" style="display:none;">
                    <video id="mixedPreview_video" class="media-preview" style="display:none;" controls></video>
                    <input type="text" id="heroImg" placeholder="/img/interior-cafe.jpg">
                </div>

                <div class="form-group">
                    <label>Ù„ÛŒÙ†Ú© Ù„ÙˆÚ©ÛŒØ´Ù† (Google Maps)</label>
                    <input type="text" id="location" placeholder="geo:35.849187,50.981813">
                </div>

                <div class="form-group">
                    <label>Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</label>
                    <input type="text" id="instagram" placeholder="https://instagram.com/tia_.cafe">
                </div>
            </div>

            <!-- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ùˆ -->
            <div class="section">
                <div class="section-title">ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ùˆ</div>

                <div class="category-tabs" id="categoryTabs"></div>

                <div id="menuItemsContainer"></div>

                <button class="btn btn-success" onclick="addNewItem()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯</button>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="saveChanges()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                <button class="btn" onclick="loadData()">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
                <button class="btn btn-danger" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <script>
        let contentData = null;
        let currentCategory = 'espressobar';
        let GITHUB_REPO = '';
        let GITHUB_TOKEN = '';

        // Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÚ©Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
        window.onload = () => {
            const savedToken = localStorage.getItem('github_token');
            const savedRepo = localStorage.getItem('github_repo');

            if (savedToken && savedRepo) {
                GITHUB_TOKEN = savedToken;
                GITHUB_REPO = savedRepo;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
                loadData();
            } else {
                document.getElementById('authSection').style.display = 'block';
            }
        };

        function authenticate() {
            const token = document.getElementById('tokenInput').value.trim();
            const repo = document.getElementById('repoInput').value.trim();

            if (!token || !repo) {
                alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                return;
            }

            GITHUB_TOKEN = token;
            GITHUB_REPO = repo;

            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            localStorage.setItem('github_token', token);
            localStorage.setItem('github_repo', repo);

            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';

            loadData();
        }

        function logout() {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            localStorage.removeItem('github_token');
            localStorage.removeItem('github_repo');

            location.reload();
        }

        async function loadData() {
            showLoading(true);
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data/content.json`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ùˆ Ù†Ø§Ù… repository Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
                }

                const data = await response.json();
                console.log(data);

                // Decode base64 properly to handle Unicode (UTF-8)
                const binaryString = atob(data.content);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const content = new TextDecoder('utf-8').decode(bytes);

                contentData = JSON.parse(content);
                console.log(contentData);
                contentData.sha = data.sha;

                populateForm();
                showMessage('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
            } catch (error) {
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        function populateForm() {
            document.getElementById('heroImg').value = contentData.homepage.heroImg;
            document.getElementById('location').value = contentData.homepage.location;
            document.getElementById('instagram').value = contentData.homepage.instagram;

            renderCategoryTabs();
            renderMenuItems();
        }

        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = '';

            contentData.menu.categories.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'category-tab' + (cat.id === currentCategory ? ' active' : '');
                tab.textContent = cat.nameFA;
                tab.onclick = () => {
                    currentCategory = cat.id;
                    renderCategoryTabs();
                    renderMenuItems();
                };
                container.appendChild(tab);
            });
        }

        function renderMenuItems() {
            const container = document.getElementById('menuItemsContainer');
            container.innerHTML = '';

            const category = contentData.menu.categories.find(c => c.id === currentCategory);
            if (!category) return;

            container.innerHTML += `
                <div class="category-hidden-checkbox">
                    <p>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø®ÙÛŒ Ø´ÙˆØ¯ØŸ</p>
                    <input type="checkbox" ${category.hidden == 'false' ? "" : "checked"}/>
                </div>
            `;

            category.items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.innerHTML = `
                    <div class="menu-item-header">
                        <strong>${item.nameFA || 'Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯'}</strong>
                        <button class="btn btn-danger" onclick="deleteItem(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ</label>
                        <input type="text" value="${item.nameFA}" onchange="updateItem(${index}, 'nameFA', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</label>
                        <input type="text" value="${item.nameEN}" onchange="updateItem(${index}, 'nameEN', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ±</label>
                        <input type="text" value="${item.img}" onchange="updateItem(${index}, 'img', this.value)">
                        ${item.img ? `<img src="${'https://tiacafe.org' + item.img}" class="image-preview">` : ''}
                    </div>
                    
                    <div class="form-group">
                        <label>Ù‚ÛŒÙ…Øª Ø§ÙˆÙ„</label>
                        <input type="text" value="${item.price1 || ''}" onchange="updateItem(${index}, 'price1', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Ù‚ÛŒÙ…Øª Ø¯ÙˆÙ…</label>
                        <input type="text" value="${item.price2 || ''}" onchange="updateItem(${index}, 'price2', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
                        <textarea onchange="updateItem(${index}, 'description', this.value)">${item.description || ''}</textarea>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateItem(index, field, value) {
            const category = contentData.menu.categories.find(c => c.id === currentCategory);
            category.items[index][field] = value;
        }

        function deleteItem(index) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            const category = contentData.menu.categories.find(c => c.id === currentCategory);
            category.items.splice(index, 1);
            renderMenuItems();
        }

        function addNewItem() {
            const category = contentData.menu.categories.find(c => c.id === currentCategory);
            category.items.push({
                id: 'new-item-' + Date.now(),
                nameFA: 'Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯',
                nameEN: 'New Item',
                img: '/img/icon-menu.svg',
                price1: '',
                price2: '',
                description: ''
            });
            renderMenuItems();
        }

        function handleImageUpload(type, input) {
            const file = input.files[0];
            if (!file) return;

            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            const reader = new FileReader();
            reader.onload = (e) => {
                showMessage('âš ï¸ ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±ØŒ Ø¨Ø§ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡ img/ Ù…Ø®Ø²Ù† GitHub Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            };
            reader.readAsDataURL(file);
        }

        async function saveChanges() {
            contentData.homepage.heroImg = document.getElementById('heroImg').value;
            contentData.homepage.location = document.getElementById('location').value;
            contentData.homepage.instagram = document.getElementById('instagram').value;

            showLoading(true);
            try {
                const content = JSON.stringify(contentData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));

                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data/content.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Update content via admin panel - ' + new Date().toISOString(),
                        content: encodedContent,
                        sha: contentData.sha
                    })
                });

                if (!response.ok) {
                    throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª');
                }

                const data = await response.json();
                contentData.sha = data.content.sha;

                showMessage('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! GitHub Actions Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø³Ø§ÛŒØª Ø§Ø³Øª...', 'success');
                alert('ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! GitHub Actions Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø³Ø§ÛŒØª Ø§Ø³Øª...');

            } catch (error) {
                showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª: ' + error.message, 'error');
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        function showMessage(message, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = 'status-message status-' + type;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        async function handleMediaUpload(section, input) {
            const file = input.files[0];
            if (!file) return;

            const isVideo = file.type.startsWith('video/');
            const isImage = file.type.startsWith('image/');

            // Show preview
            let preview;
            if (section === 'hero') {
                // Hide both previews first
                document.getElementById('mixedPreview').style.display = 'none';
                document.getElementById('mixedPreview_video').style.display = 'none';
                preview = isVideo ? document.getElementById('mixedPreview_video') : document.getElementById('mixedPreview');
            } else {
                preview = document.getElementById(`${section}Preview`);
            }

            if (preview) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            // Upload to GitHub
            try {
                const result = await uploadToGitHub(file, section);
                alert(`Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\n\nØ¢Ø¯Ø±Ø³ ÙØ§ÛŒÙ„:\n${result.url}`);
                console.log('Upload result:', result);
                document.getElementById('heroImg').value = '/' + result.path;
            } catch (error) {
                console.error('Upload error:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ' + error.message);
            }
        }

        // Upload file to GitHub repository
        async function uploadToGitHub(file, section) {
            // Generate filename with timestamp
            const timestamp = Date.now();
            const extension = file.name.split('.').pop();
            const folder = 'img';
            const filename = `${section}_${timestamp}.${extension}`;
            const path = `${folder}/${filename}`;

            // Convert file to base64
            const base64Content = await fileToBase64(file);

            // Check if file exists (get SHA if it does)
            let sha = null;
            try {
                const checkResponse = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (checkResponse.ok) {
                    const data = await checkResponse.json();
                    sha = data.sha;
                }
            } catch (e) {
                // File doesn't exist, which is fine for new uploads
            }

            // Upload to GitHub
            const uploadData = {
                message: `${new Date().toISOString()} Upload media`,
                content: base64Content,
                branch: 'main'
            };

            if (sha) {
                uploadData.sha = sha;
            }

            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(uploadData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Upload failed');
            }

            const result = await response.json();

            return {
                path: path,
                url: result.content.download_url,
                htmlUrl: result.content.html_url
            };
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Setup drag and drop for all upload zones
        document.querySelectorAll('.image-upload').forEach((zone, index) => {
            const inputs = ['mixedInput'];
            const sections = ['mixed'];

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const input = document.getElementById(inputs[index]);
                    input.files = files;
                    handleMediaUpload(sections[index], input);
                }
            });
        });
    </script>
</body>

</html>